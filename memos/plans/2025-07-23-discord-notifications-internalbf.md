# Discord Notifications via InternalBF Implementation Memo

## Overview

Set up GitHub notifications (deployments, PR events) that get sent to Discord
via our internalbf service deployed to internalbf.com. This creates a
centralized notification system using our existing Discord bot infrastructure.

## Architecture

- **GitHub Webhooks** â†’ **internalbf.com/webhooks/github** â†’ **Discord via
  existing bot**
- **Single webhook endpoint** handles all GitHub events and routes internally
- **Host-based routing** via Kamal on same Hetzner server as boltfoundry-com
- **Separate domain** (internalbf.com) for clean service separation

## Implementation Steps

### 1. Deploy internalbf to Hetzner

#### Infrastructure Changes

- [x] Add DNS record for internalbf.com pointing to same server IP
- [x] Create Kamal config template for internalbf deployment
- [x] Update Terraform to generate both deploy configs
- [x] Create Dockerfile for internalbf binary

#### Deployment

- [x] Create GitHub workflow for internalbf deployment
- [x] Configure Kamal secrets for Discord bot tokens
- [ ] Test deployment to ensure internalbf.com resolves correctly

### 2. GitHub Webhook Configuration

#### Webhook Endpoint

- [x] Add URLPattern-based routing to internalbf
- [x] Create `/webhooks/github` endpoint that handles all GitHub events
- [x] Route events based on `x-github-event` header:
  - `workflow_run` â†’ deployment notifications
  - `pull_request` â†’ PR merge notifications
  - `pull_request_review` â†’ review request notifications

#### Event Filtering

- **Deployments**: Only completed workflows named "Deploy boltfoundry-com" or
  "Deploy internalbf"
- **PRs**: Only merged pull requests
- **Reviews**: Only review_requested actions

### 3. Discord Integration

#### Configuration

- [x] Reuse existing Discord client from ThanksBot
- [x] Add `DISCORD_NOTIFICATIONS_CHANNEL_ID` environment variable
- [x] Send formatted messages to designated channel

#### Message Formats

```
âœ… **Deployment succeeded**
**Workflow:** Deploy boltfoundry-com
**Repository:** bolt-foundry/bolt-foundry
**Branch:** main
**Commit:** abc1234
**URL:** https://github.com/...

ðŸŽ‰ **Pull Request Merged**
**Title:** Add new feature
**Repository:** bolt-foundry/bolt-foundry
**Author:** username
**Merged by:** username
**URL:** https://github.com/...

ðŸ‘€ **Review Requested**
**Title:** Fix bug in component
**Repository:** bolt-foundry/bolt-foundry
**Author:** username
**Reviewer:** username
**URL:** https://github.com/...
```

### 4. GitHub Repository Configuration

#### Webhook Setup

- [ ] Add webhook in GitHub repo settings:
  - **URL**: `https://internalbf.com/webhooks/github`
  - **Events**: workflow_run, pull_request, pull_request_review
  - **Content-Type**: application/json

#### Secrets Required

- [x] `DISCORD_NOTIFICATIONS_CHANNEL_ID` - Discord channel ID for notifications
- [x] `THANKSBOT_TOKEN` - Discord bot token (reused)
- [x] `THANKSBOT_NOTION_TOKEN` - Notion integration (existing)
- [x] `THANKSBOT_NOTION_DATABASE_ID` - Notion database (existing)

### 5. Remove Old Notification System

#### Clean up deploy-boltfoundry-com.yml

- [ ] Remove old echo-based notification steps
- [ ] Deployment notifications now handled via GitHub webhook to internalbf

## File Changes Made

### New Files

```
apps/internalbf/Dockerfile
infra/terraform/hetzner/deploy-internalbf.yml.tpl
config/deploy-internalbf.yml (generated by Terraform)
.github/workflows/deploy-internalbf.yml
```

### Modified Files

```
apps/internalbf/internalbf.ts - Added webhook routing and Discord integration
infra/terraform/hetzner/main.tf - Added internalbf.com DNS and Kamal config generation
```

## Deployment Commands

### Initial Setup

```bash
# Deploy infrastructure (adds DNS record)
cd infra/terraform/hetzner
terraform apply

# Deploy internalbf service
git push origin main  # Triggers deploy-internalbf.yml workflow
```

### Verification

```bash
# Test webhook endpoint
curl -X POST https://internalbf.com/webhooks/github \
  -H "Content-Type: application/json" \
  -H "X-GitHub-Event: ping" \
  -d '{"zen":"GitHub is awesome"}'

# Check Discord bot status
curl https://internalbf.com/
```

## Configuration Requirements

### GitHub Repository Webhook

- **URL**: `https://internalbf.com/webhooks/github`
- **Content type**: `application/json`
- **Events**:
  - Workflow runs
  - Pull requests
  - Pull request reviews
- **Active**: âœ“

### Discord Channel Setup

- [ ] Create dedicated notifications channel
- [ ] Get channel ID and add to GitHub secrets as
      `DISCORD_NOTIFICATIONS_CHANNEL_ID`
- [ ] Ensure bot has permission to send messages to channel

### Environment Variables

```bash
# Production (set in Kamal secrets)
DISCORD_NOTIFICATIONS_CHANNEL_ID=123456789  # Discord channel ID
THANKSBOT_TOKEN=...                          # Discord bot token
THANKSBOT_NOTION_TOKEN=...                   # Existing Notion integration
THANKSBOT_NOTION_DATABASE_ID=...             # Existing Notion database
```

## Benefits

1. **Centralized**: All GitHub notifications go through one service
2. **Extensible**: Easy to add new event types or notification channels
3. **Reliable**: Uses existing Discord bot infrastructure
4. **Clean**: Separate domain for service separation
5. **Maintainable**: Single webhook URL to manage

## Testing Checklist

- [ ] Verify internalbf.com resolves to server IP
- [ ] Test webhook endpoint responds to POST requests
- [ ] Verify Discord bot can send messages to notifications channel
- [ ] Test deployment notifications (trigger a deployment)
- [ ] Test PR notifications (merge a test PR)
- [ ] Test review request notifications (request review on test PR)
- [ ] Verify webhook shows up in GitHub delivery logs

## Troubleshooting

### Common Issues

1. **DNS not resolving**: Check Cloudflare DNS record exists and is proxied
2. **Webhook timeouts**: Verify internalbf service is running on port 9999
3. **Discord messages not sending**: Check bot token and channel ID are correct
4. **404 on webhook**: Verify URLPattern routing is working correctly

### Debug Commands

```bash
# Check service status
kamal app logs -c config/deploy-internalbf.yml

# Test DNS resolution
nslookup internalbf.com

# Check server routing
curl -v https://internalbf.com/

# Test webhook locally
curl -X POST http://localhost:9999/webhooks/github \
  -H "Content-Type: application/json" \
  -H "X-GitHub-Event: ping" \
  -d '{"zen":"test"}'
```

## Future Enhancements

- [ ] Add webhook signature verification for security
- [ ] Support for more GitHub event types (issues, releases, etc.)
- [ ] Multiple Discord channels for different event types
- [ ] Slack integration using same webhook system
- [ ] Rate limiting for webhook endpoints
- [ ] Metrics/monitoring for notification delivery
