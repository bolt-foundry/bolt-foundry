name: CI

on:
  push:
    branches: [main]
  pull_request:
  workflow_dispatch:

jobs:
  build:
    name: bff ci
    runs-on: ubuntu-latest

    env:
      DATABASE_URL:        ${{ secrets.DATABASE_URL }}
      ASSEMBLY_AI_KEY:     ${{ secrets.ASSEMBLY_AI_KEY }}
      OPEN_AI_API_KEY:     ${{ secrets.OPEN_AI_API_KEY }}
      OPEN_ROUTER_API_KEY: ${{ secrets.OPEN_ROUTER_API_KEY }}
      POSTHOG_API_KEY:     ${{ secrets.POSTHOG_API_KEY }}
      WAITLIST_API_KEY:    ${{ secrets.WAITLIST_API_KEY }}
      INFRA_BIN_PATH:      ${{ github.workspace }}/infra/bin
      
    # FlakeHub Cache needs OIDC so it can mint its own short-lived token
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Set environment variables
        run: |
          echo "$GITHUB_WORKSPACE/infra/bin" >> $GITHUB_PATH
      
      - uses: DeterminateSystems/nix-installer-action@main
        with:
          determinate: true
      - uses: DeterminateSystems/flakehub-cache-action@main
      - uses: DeterminateSystems/nix-flake-checker-action@main
      - run: nix flake check