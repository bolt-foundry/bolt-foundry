name: CI
on: [pull_request]

jobs:
  build:
    name: BFF CI
    runs-on: ubuntu-latest
    steps:
      # Checkout code
      - name: Checkout
        uses: actions/checkout@v4

      # Setup Nix with flakes enabled
      - name: Setup Nix
        uses: cachix/install-nix-action@v25
        with:
          extra_nix_config: |
            experimental-features = nix-command flakes

      # Prepare environment variables and directories
      - name: Set environment variables
        run: |
          # Set environment variables
          echo "INFRA_BIN_PATH=$GITHUB_WORKSPACE/infra/bin" >> $GITHUB_ENV
          echo "BF_ENV=DEVELOPMENT" >> $GITHUB_ENV

          # Make infra/bin directory and ensure it's executable
          mkdir -p $GITHUB_WORKSPACE/infra/bin
          chmod -R +x $GITHUB_WORKSPACE/infra/bin

          # Add infra/bin to PATH
          echo "$GITHUB_WORKSPACE/infra/bin" >> $GITHUB_PATH

      # Set secrets as environment variables
      - name: Set secrets
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          ASSEMBLY_AI_KEY: ${{ secrets.ASSEMBLY_AI_KEY }}
          OPEN_AI_API_KEY: ${{ secrets.OPEN_AI_API_KEY }}
          OPEN_ROUTER_API_KEY: ${{ secrets.OPEN_ROUTER_API_KEY }}
          POSTHOG_API_KEY: ${{ secrets.POSTHOG_API_KEY }}
          OTEL_EXPORTER_OTLP_HEADERS: authorization=${{ secrets.HYPERDX_INGESTION_KEY }}
          OTEL_EXPORTER_OTLP_ENDPOINT: https://in-otel.hyperdx.io
          OTEL_SERVICE_NAME: CONTENT_FOUNDRY
        run: |
          echo "Required environment variables have been set"

      # Make bff executable if it exists
      - name: Prepare bff tool
        run: |
          if [ -f "$INFRA_BIN_PATH/bff" ]; then
            chmod +x $INFRA_BIN_PATH/bff
          fi

      # Run CI using Nix flake
      - name: Run BFF CI with flake
        run: |
          # Use the flake's devShell which includes the shellHook to run deno install
          nix develop --command bash -c '
            # Ensure infra/bin is in PATH
            export PATH=$INFRA_BIN_PATH:$PATH

            # Run deno install explicitly (in case shellHook didn't run it)
            deno install

            # Run the CI command
            bff ci -g
          '