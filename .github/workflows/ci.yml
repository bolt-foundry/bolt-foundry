          name: CI

          on: [pull_request, workflow_dispatch]

          concurrency:
            group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
            cancel-in-progress: true

          jobs:
            # 1️⃣ Nix build + cache + (optionally) FlakeHub publish
            DeterminateCI:
              uses: DeterminateSystems/ci/.github/workflows/workflow.yml@main
              permissions:
                id-token: write
                contents: read
              secrets: inherit

            # 2️⃣ Custom test phase that piggy-backs on the cache
            bff-tests:
              needs: DeterminateCI
              runs-on: ubuntu-latest
              permissions:
                contents: read
              env:
                DATABASE_URL:       ${{ secrets.DATABASE_URL }}
                ASSEMBLY_AI_KEY:    ${{ secrets.ASSEMBLY_AI_KEY }}
                OPEN_AI_API_KEY:    ${{ secrets.OPEN_AI_API_KEY }}
                OPEN_ROUTER_API_KEY:${{ secrets.OPEN_ROUTER_API_KEY }}
                POSTHOG_API_KEY:    ${{ secrets.POSTHOG_API_KEY }}
                WAITLIST_API_KEY:   ${{ secrets.WAITLIST_API_KEY }}
                JWT_SECRET:         ${{ secrets.JWT_SECRET }}

              steps:
                #–––––––––––––––––––––––––––––––––––––––––––––––
                - name: Set environment variables
                  run: echo "$GITHUB_WORKSPACE/infra/bin" >> $GITHUB_PATH

                - uses: actions/checkout@v4
                  with: { fetch-depth: 0 }

                # 📦 Cache node_modules (works for npm / pnpm / yarn / bun)
                - name: Cache node_modules
                  id: cache-node
                  uses: actions/cache@v4
                  with:
                    path: |
                      **/node_modules
                    key: |
                      node-${{ runner.os }}-${{ hashFiles('**/package-lock.json', '**/pnpm-lock.yaml', '**/yarn.lock', '**/bun.lockb') }}
                    restore-keys: |
                      node-${{ runner.os }}-

                # 📦 Cache vendor (adjust the lock file if you use another tool)
                - name: Cache vendor
                  id: cache-vendor
                  uses: actions/cache@v4
                  with:
                    path: vendor
                    key: |
                      vendor-${{ runner.os }}-${{ hashFiles('**/deno.lock') }}
                    restore-keys: |
                      vendor-${{ runner.os }}-

                #–––––––––––––––––––––––––––––––––––––––––––––––
                # Light-weight Nix bootstrap that reuses the store populated by DeterminateCI
                - uses: DeterminateSystems/nix-installer-action@v9
                  with: { determinate: true }

                - uses: DeterminateSystems/magic-nix-cache-action@v2  # hits the store-wide cache

                #–––––––––––––––––––––––––––––––––––––––––––––––
                - name: Enter dev shell & run bff CI
                  run: |
                    cd "$GITHUB_WORKSPACE"
                    nix develop . --impure --command bash -c "
                      bff ci -g --include-bolt-foundry
                    "
