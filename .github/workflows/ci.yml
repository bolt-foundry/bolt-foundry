name: CI
on: [pull_request]

jobs:
  build:
    name: bff ci
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # Use Nix with the exact same commit as specified in replit.nix
      - uses: cachix/install-nix-action@v25
        with:
          nix_path: nixpkgs=github:NixOS/nixpkgs/26e168479fdc7a75fe55e457e713d8b5f794606a

      # Parse .replit file for environment variables
      - name: Parse .replit env and export to GitHub Actions
        run: |
          # Extract environment variables from [env] section
          env_section=$(sed -n '/^\[env\]/,/^\[/p' .replit | grep -v '^\[' | grep -v '^#' | grep '=')

          # Process each variable
          echo "Setting environment variables from .replit [env] section"
          while IFS= read -r line; do
            # Skip empty lines and comments
            if [[ -z "$line" || "$line" =~ ^# ]]; then
              continue
            fi

            # Extract variable name and value
            if [[ "$line" =~ ([A-Za-z0-9_]+)[[:space:]]*=[[:space:]]*(.*) ]]; then
              var_name="${BASH_REMATCH[1]}"
              var_value="${BASH_REMATCH[2]}"

              # Clean up value (remove quotes, etc.)
              var_value=$(echo "$var_value" | sed 's/^"\(.*\)"$/\1/' | sed "s/^'\(.*\)'$/\1/")

              # Replace Replit variables with GitHub equivalents
              var_value="${var_value//\$REPL_HOME/$GITHUB_WORKSPACE}"

              # Skip PATH as we'll handle it separately
              if [[ "$var_name" != "PATH" ]]; then
                echo "Setting $var_name=$var_value"
                echo "$var_name=$var_value" >> $GITHUB_ENV
              fi
            fi
          done <<< "$env_section"

          # Extract PATH adjustments
          if grep -q 'PATH[[:space:]]*=' .replit; then
            path_addition=$(grep 'PATH[[:space:]]*=' .replit | sed 's/PATH[[:space:]]*=[[:space:]]*//' | sed 's/"//g')
            path_addition="${path_addition//\$REPL_HOME/$GITHUB_WORKSPACE}"
            path_addition="${path_addition//\$PATH/:}"
            echo "Adding to PATH: $path_addition"
            echo "$path_addition" >> $GITHUB_PATH
          fi

      # Set secrets as environment variables
      - name: Set secrets as environment variables
        run: |
          echo "DATABASE_URL=${{ secrets.DATABASE_URL }}" >> $GITHUB_ENV
          echo "ASSEMBLY_AI_KEY=${{ secrets.ASSEMBLY_AI_KEY }}" >> $GITHUB_ENV
          echo "OPEN_AI_API_KEY=${{ secrets.OPEN_AI_API_KEY }}" >> $GITHUB_ENV
          echo "OPEN_ROUTER_API_KEY=${{ secrets.OPEN_ROUTER_API_KEY }}" >> $GITHUB_ENV
          echo "POSTHOG_API_KEY=${{ secrets.POSTHOG_API_KEY }}" >> $GITHUB_ENV
          echo "OTEL_EXPORTER_OTLP_HEADERS=authorization=${{ secrets.HYPERDX_INGESTION_KEY }}" >> $GITHUB_ENV
          echo "OTEL_EXPORTER_OTLP_ENDPOINT=https://in-otel.hyperdx.io" >> $GITHUB_ENV
          echo "OTEL_SERVICE_NAME=CONTENT_FOUNDRY" >> $GITHUB_ENV

      # Setup and use Nix environment based on replit.nix
      - name: Setup and use Nix environment
        run: |
          # Ensure infra/bin directory exists and is executable
          mkdir -p $GITHUB_WORKSPACE/infra/bin
          chmod -R +x $GITHUB_WORKSPACE/infra/bin

          # Import and use environment from replit.nix directly
          echo "Loading dependencies from replit.nix..."
          nix-shell --run "echo 'Nix environment loaded successfully'" -E "
            let
              pkgs = import <nixpkgs> { };
              replit = import ./replit.nix { 
                inherit pkgs; 
                system = builtins.currentSystem;
              };
            in
              pkgs.mkShell {
                buildInputs = replit.deps;
              }
          "

          # List available tools for debugging
          nix-shell --run "which python && python --version || echo 'Python not found'" -E "
            let
              pkgs = import <nixpkgs> { };
              replit = import ./replit.nix { 
                inherit pkgs; 
                system = builtins.currentSystem;
              };
            in
              pkgs.mkShell {
                buildInputs = replit.deps;
              }
          "

      # Run CI command
      - name: Run CI in nix
        run: |
          nix-shell --run "
            # Check if bff is available
            if [ -f \"$GITHUB_WORKSPACE/infra/bin/bff\" ]; then
              echo \"Found bff tool at $GITHUB_WORKSPACE/infra/bin/bff\"
              chmod +x $GITHUB_WORKSPACE/infra/bin/bff

              # Run the CI command
              bff ci -g
            else
              echo \"bff tool not found in infra/bin directory. Checking PATH...\"
              which bff && bff ci -g || echo \"bff command not found in PATH\"
            fi
          " -E "
            let
              pkgs = import <nixpkgs> { };
              replit = import ./replit.nix { 
                inherit pkgs; 
                system = builtins.currentSystem;
              };
            in
              pkgs.mkShell {
                buildInputs = replit.deps;
              }
          "