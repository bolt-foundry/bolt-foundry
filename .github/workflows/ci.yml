name: CI
on: [pull_request]

jobs:
  build:
    name: bff ci
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: cachix/install-nix-action@v25
        with:
          nix_path: nixpkgs=channel:nixos-24.11

      - name: Setup Nix environment
        run: |
          # Check if nix flake is recognized
          nix --version
          
          # Use the flake.nix for dependencies
          nix develop --impure --command bash -c "echo 'Nix environment activated successfully'"
          
          # Add the devShell's bin path to PATH
          echo "PATH=$(nix develop --impure --command bash -c 'echo $PATH'):$PATH" >> $GITHUB_ENV

      - name: Set environment variables
        run: |
          echo "DATABASE_URL=${{ secrets.DATABASE_URL }}" >> $GITHUB_ENV
          echo "ASSEMBLY_AI_KEY=${{ secrets.ASSEMBLY_AI_KEY }}" >> $GITHUB_ENV
          echo "OPEN_AI_API_KEY=${{ secrets.OPEN_AI_API_KEY }}" >> $GITHUB_ENV
          echo "OPEN_ROUTER_API_KEY=${{ secrets.OPEN_ROUTER_API_KEY }}" >> $GITHUB_ENV
          echo "POSTHOG_API_KEY=${{ secrets.POSTHOG_API_KEY }}" >> $GITHUB_ENV
          echo "INFRA_BIN_PATH=$GITHUB_WORKSPACE/infra/bin" >> $GITHUB_ENV
          echo "$GITHUB_WORKSPACE/infra/bin" >> $GITHUB_PATH

      - name: Run CI in nix
        run: |
          nix develop --impure --command bash -c "
            # Check if bff is available
            which bff || echo 'bff command not found'
            
            # Run the CI command
            bff ci -g
          "