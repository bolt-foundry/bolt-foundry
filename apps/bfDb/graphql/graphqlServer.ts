#! /usr/bin/env -S deno run --allow-write --allow-read --allow-env

import { connectionPlugin, makeSchema } from "nexus";
import { createYoga } from "graphql-yoga";

import * as oldTypes from "apps/bfDb/graphql/__generated__/graphqlTypesList.ts";
import { createContext } from "apps/bfDb/graphql/graphqlContext.ts";
import type { SchemaConfig } from "nexus/dist/builder.js";
import { getLogger } from "packages/logger/logger.ts";
import { loadModelTypes } from "apps/bfDb/graphql/builder/loadSpecs.ts";

const logger = getLogger(import.meta);

const schemaOptions: SchemaConfig = {
  types: { ...loadModelTypes(), ...oldTypes },
  features: {
    abstractTypeStrategies: {
      __typename: true,
    },
  },
  plugins: [
    connectionPlugin({
      validateArgs: (args) => {
        if (args.first == null && args.last == null) {
          args.first = 10;
        }
        return args;
      },
      extendConnection: {
        count: {
          type: "Int",
          requireResolver: false,
        },
      },
      includeNodesField: true,
    }),
  ],
};

export const schema = makeSchema(schemaOptions);

// Create a Yoga instance with a GraphQL schema.
export const yoga = createYoga({ schema });

export const graphQLHandler = async (req: Request) => {
  using ctx = await createContext(req);
  // @ts-expect-error bad types or something
  const res = await yoga.handleRequest(req, ctx);
  const responseHeaders = ctx.getResponseHeaders();

  for (const [key, value] of responseHeaders) {
    res.headers.set(key, value);
  }

  return res;
};

function makeNameThing(fileName: string) {
  return `export * from "apps/bfDb/graphql/types/${fileName}";\n`;
}

if (import.meta.main) {
  logger.info("Building GraphQL schema...");
  const files = Deno.readDir(
    new URL(import.meta.resolve("apps/bfDb/graphql/types")),
  );
  const nextTypes = [];

  for await (const file of files) {
    if (file.name.startsWith("graphql") && file.name.endsWith(".ts")) {
      nextTypes.push(file.name);
    }
  }

  nextTypes.sort();

  const fileString = `
/* @generated */
/* magical note: this was generated by server.ts. */

${nextTypes.map(makeNameThing).join("")}

/* you're welcome. */
  `;

  await Deno.writeTextFile(
    new URL(import.meta.resolve("./__generated__/graphqlTypesList.ts")),
    fileString,
  );

  const types = await import(
    "apps/bfDb/graphql/__generated__/graphqlTypesList.ts"
  );

  makeSchema({
    ...schemaOptions,
    types,
    contextType: {
      module: import.meta.resolve("./graphqlContext.ts").replace("file://", ""),
      export: "Context",
    },
    formatTypegen: (content, type) => {
      if (type === "schema") {
        return `### @generated \n${content}`;
      } else {
        return `/* @generated */\n// deno-lint-ignore-file\n${
          content.replace(
            /(["'])(\.+\/[^"']+)\1/g,
            "$1$2.ts$1",
          )
        }`;
      }
    },
    outputs: {
      schema: new URL(
        import.meta.resolve(`apps/bfDb/graphql/__generated__/schema.graphql`),
      )
        .pathname,
      typegen: new URL(
        import.meta.resolve(`apps/bfDb/graphql/__generated__/_nexustypes.ts`),
      )
        .pathname,
    },
  });
}
