### Implementation Plan – `bff eval` (v0.1)

---

#### Overview

This version ships a **single sub‑command**—`bff eval`—inside the Bolt Foundry
CLI. It runs an evaluation dataset (JSONL) through a user‑supplied judge module,
shows a moon‑phase throbber while processing, prints a monochrome results table,
and can emit JSON and full artifacts.

The tool is **Deno 2‑native** for local and CI use, **plus** we publish a small
npm wrapper so developers can also execute it with `npx bff-eval`. The wrapper
simply forwards args to an embedded, Node‑compiled build produced by
`deno compile --target node`.

---

#### Goals

| Goal                    | Description                                                   | Success Criteria                                                      |
| ----------------------- | ------------------------------------------------------------- | --------------------------------------------------------------------- |
| Deno 2 binary           | Provide a single cross‑platform executable via `deno compile` | Running `bff eval -i data.jsonl -j judge.ts` works on macOS/Linux/Win |
| npx shim                | Allow `npx bff-eval …` for Node users                         | npm install succeeds; shim forwards to same results                   |
| Sub‑command integration | Part of the multi‑command `bff` CLI, invoked as `bff eval`    | `bff --help` lists `eval`; alias `bff-eval` still works               |
| Ergonomic flags         | Flags & defaults per spec (stdin, required judge, etc.)       | CLI tests cover each flag & alias                                     |
| CI‑friendly failure     | `--fail-below` exits 1 when threshold unmet                   | Integration test passes/fails appropriately                           |
| Artifacts directory     | Persist full payloads when `--artifacts <dir>`                | Files follow `<id>.json` naming rules                                 |

---

#### Anti‑Goals

| Anti‑Goal                           | Reason             |
| ----------------------------------- | ------------------ |
| Config file parsing                 | Keep v0.1 minimal  |
| Partial‑run (`--limit`, `--sample`) | Defer until needed |

---

#### Technical Approach

1. **Flag parsing** – Use `std/flags` from Deno standard library; short aliases
   mapped manually.
2. **Binary builds**

   - **Deno 2**:
     `deno compile --allow-read --allow-write --allow-env --allow-run --name bff`
     builds the native exec.
   - **npm**: same source compiled with `--target node`, wrapped by a tiny
     `#!/usr/bin/env node` launcher published as `bff-eval`.
3. **Input streaming** – Use `Deno.iter` + `TextDecoder` to process JSONL
   line‑by‑line; validate `id`, `prompt`, `expected` (generate sequential IDs
   when missing).
4. **Judge loading** – Dynamic `import(judgePath, { with: { type: "module" }})`;
   validate `default` export matches minimal contract
   `{ score:number, notes?:string }`.
5. **Concurrency** – Worker pool implemented with `Promise.allSettled` slices
   when `--concurrency` set; unlimited otherwise.
6. **Progress UI** – `stdout.write("\r" + moonFrames[idx++ % 8])` every 120 ms;
   replace with ⚡ on completion.
7. **Aggregation** – Mean by default; alternate ops via `--aggregate` switch.
8. **Rendering** –

   - **Table**: simple column widths computed manually (avoid third‑party libs).
   - **JSON**: full summary + per‑example array when `--format json`.
9. **Artifacts** – If `--artifacts`, write `<dir>/<id>.json` (or zero‑pad index)
   containing prompt, completion, expected, score, notes.
10. **Exit codes** – 1 when aggregate < `--fail-below`, else 0; 2 for CLI
    misuse.

---

#### Components

| Status | Component            | Purpose                                    |
| ------ | -------------------- | ------------------------------------------ |
| \[ ]   | `cli/eval.ts`        | Flag parsing & orchestration (sub‑command) |
| \[ ]   | `lib/inputReader.ts` | JSONL stream + validation                  |
| \[ ]   | `lib/judgeLoader.ts` | Dynamic import & signature check           |
| \[ ]   | `lib/runner.ts`      | Concurrency queue & per‑item exec          |
| \[ ]   | `lib/progress.ts`    | Moon‑phase throbber                        |
| \[ ]   | `lib/aggregator.ts`  | mean / median / min / max calc             |
| \[ ]   | `lib/table.ts`       | Monochrome console table                   |
| \[ ]   | `lib/jsonOut.ts`     | JSON formatting & write                    |
| \[ ]   | `lib/artifacts.ts`   | Persist raw payloads                       |
| \[ ]   | `bin/bff.ts`         | Top‑level Deno CLI exposing sub‑commands   |
| \[ ]   | `npm/shim.js`        | Node wrapper for npx users                 |

---

#### Technical Decisions

| Decision                          | Reasoning                                                            | Alternatives                            |
| --------------------------------- | -------------------------------------------------------------------- | --------------------------------------- |
| **Use Deno 2** for native runtime | Single runtime covers TS out‑of‑box, permissions model, easy compile | Node + tsx                              |
| Compile Node target for npx       | Re‑uses same codebase; keeps JS ecosystem happy                      | Maintain separate Node build            |
| Manual `std/flags` parsing        | Avoid external deps; stable                                          | oak\_cli, cliffy                        |
| Home‑rolled table                 | Reduce deps; monochrome requirement                                  | `cli-table3` via npm (would bloat shim) |

---

#### Next Steps

| Question                                                     | How to Explore                                        |
| ------------------------------------------------------------ | ----------------------------------------------------- |
| Confirm Deno 2 `compile --target node` output size/licensing | Run spike, inspect bundle                             |
| Determine publishing script for npm                          | Prototype GitHub action that compiles + `npm publish` |
| Validate Windows CR handling for progress                    | Manual test on GH runner                              |

#### Version Roadmap 0.1.x

- **0.1.0** – Core CLI skeleton: flag parsing, stdin input, judge loading, mean
  aggregation, console table, moon‑phase progress.
- **0.1.1** – Add `--format json` and `--output` support.
- **0.1.2** – Implement `--fail-below` exit‑code logic.
- **0.1.3** – Add `--concurrency` cap and aggregation selector.
- **0.1.4** – Introduce `--artifacts <dir>` full‑payload dump.
- **0.1.5** – Silent/verbose modes plus error‑skip handling.
- **0.1.6** – Publish npm wrapper (`npx bff eval`).
- **0.1.7** – Provide CI template examples and badge support.
